;; mina/src/lib/crypto/kimchi_binding/js/stubs/dune
(rule
 (enabled_if (= %{env:MARLIN_PLONK_STUBS=n} n))
 (targets libwires_15_stubs.a)
 (deps
  Cargo.toml
  ../../Cargo.toml
  ../../rust-toolchain.toml
  (source_tree src)
  (source_tree binding_generation)
  (source_tree ../wasm)
  (source_tree ../../proof-systems)
  (env_var MARLIN_PLONK_STUBS))
 (locks /cargo-lock) ;; lock for rustup
 (action
  (progn
   (setenv CARGO_TARGET_DIR
    "%{read:dune-build-root}/cargo_kimchi_stubs"
    (setenv
     RUSTFLAGS
     "-C target-feature=+bmi2,+adx"
     (run cargo build --release)))
   (run cp %{read:dune-build-root}/cargo_kimchi_stubs/release/libwires_15_stubs.a .))))

