= testing

Do not debug using `build test`. If `build test` crashes (e.g. due to
a problem in the scm code), run

    bazel run emit:mibl -c dbg -- -w test/dune/deps/dynamic -vvdt --show-mibl 2>&1 | tee log.mibl

Use ~/.config/mibl/miblrc to set debug flags, or set them on the cmd line.

Pass `--no-miblrc` to disable loading of `.config/mibl/miblrc`.

=== baseline

To generate baseline files (`.mibl/PARSETREE.{mibl,s7}` and
`.mibl/PROJECT.{mibl,s7}`) :

* To regenerate PARSETREE files only:

     bazel run emit:parsetree -c dbg -- -vvdt -w test/dune/depsdynamic 2>&1 | tee log.mibl

or

* To regenerate both:

     bazel run emit:mibl -- -w test/dune/depsdynamic --emit-parsetree

    make -C test all

    make -C test mibl w=test/dune/depsdynamic --emit-parsetree

=== unit tests

    bazel run test/dune/action_dsl:test

=== integration tests:

To test `mibl:parsetree->mibl`,  run

    bazel test test/dune/deps:mibl_test

Each test will read `.mibl/PARSETREE.s7` and transform it, then compare result to `.mibl/PROJECT.s7`.

== debugging

To enable debug logging in the scm files: in `scm/dune/debug.scm`:

(define *mibl-debug-s7* #f)

Set this to #t.  This will cause the `mibl-trace*` macros to expand at read-time.

The mibl-trace macros take a `:test` arg (boolean) that controls whether they
print or not (when `*mibl-debug-s7*` is `#t).

Global vars or form `*mibl-debug-foo* are used with `:test` to control
logging. For example in `scm/dune/action_dsl.scm` the controlling var
is `*mibl-debug-action-dsl*. E.g.

    (mibl-trace "foo" foo :test *mibl-debug-action-dsl*)

If `*mibl-debug-s7*` and *mibl-debug-action-dsl* are true, and the
value of `foo` is `(:stdout outfile)`, then this will print:

    foo: (:stdout outfile)

They also take a `:color` arg so you can set ad-hoc colors to make messages stand out in the log. E.g.

    (mibl-trace "bash-cmd" bash-cmd :test *mibl-debug-action-dsl* :color red)





